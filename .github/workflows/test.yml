name: Basic Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  USE_REAL_AZURE: ${{ secrets.USE_REAL_AZURE || 'false' }}
  FR_ENDPOINT: ${{ secrets.FR_ENDPOINT }}
  FR_ENDPOINT_KEY: ${{ secrets.FR_ENDPOINT_KEY }}
  TEST_DOCUMENT_URL: ${{ secrets.TEST_DOCUMENT_URL }}
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check syntax
      run: |
        python -m py_compile latestocr/__init__.py

    - name: Test imports
      run: |
        python -c "import latestocr.__init__; print('Imports successful')"


    - name: Test Azure Function main()
      run: |
        python - <<'EOF'
        import os, json, base64, time
        import azure.functions as func
        import latestocr.__init__ as app

        # === Environment Setup ===
        os.environ["FR_ENDPOINT"] = os.getenv("FR_ENDPOINT", "https://example.cognitiveservices.azure.com/")
        os.environ["FR_ENDPOINT_KEY"] = os.getenv("FR_ENDPOINT_KEY", "fake-key")

        # SAS URL of your blob file
        sas_url = "https://hadil.blob.core.windows.net/hadil/Hadil-BEN-AMOR-resume_updated.pdf?sp=r&st=2025-11-04T01:23:11Z&se=2026-02-05T09:38:11Z&sv=2024-11-04&sr=b&sig=Ul2DY94iNBZ1tcLn1j384%2BNT8JRYQnwawvqJltP9dXc%3D"
        sas_url = sas_url.replace(" ", "").replace("\n", "")

        # === Split and encode URL ===
        if "?" in sas_url:
            url, token = sas_url.split("?", 1)
        else:
            raise ValueError("SAS URL missing '?' separator")

        encoded_url = base64.b64encode(url.encode("utf-8")).decode("utf-8")
        while len(encoded_url) % 4 != 0:
            encoded_url += "="

        test_data = {
            "values": [
                {
                    "recordId": "1",
                    "data": {
                        "Url": encoded_url,
                        "SasToken": "?" + token
                    }
                }
            ]
        }

        # === Create request ===
        req = func.HttpRequest(
            method="POST",
            url="/api/ocr",
            body=json.dumps(test_data).encode("utf-8")
        )

        # === Measure test metrics ===
        start_time = time.time()

        resp = app.main(req)

        end_time = time.time()
        latency = end_time - start_time
        execution_time_ms = round(latency * 1000, 2)
        number_of_requests = 1  # since we are testing with one call

        # Approximate cost if known ($0.02/page, assuming 1 page)
        estimated_cost_usd = 0.02 * number_of_requests

        print("Status Code:", resp.status_code)
        print("Response Body:", resp.get_body().decode())
        print("---- TEST METRICS ----")
        print(f"Requests sent: {number_of_requests}")
        print(f"Execution time (ms): {execution_time_ms}")
        print(f"Estimated cost (USD): {estimated_cost_usd:.4f}")
        EOF
