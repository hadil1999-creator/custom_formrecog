name: Test Azure Function

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Azure Functions Core Tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
        sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
        sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
        sudo apt-get update
        sudo apt-get install azure-functions-core-tools-4

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up environment variables
      run: |
        echo "FR_ENDPOINT=https://test-endpoint.api.cognitive.microsoft.com" >> $GITHUB_ENV
        echo "FR_ENDPOINT_KEY=test-key" >> $GITHUB_ENV

    - name: Start Azure Function locally
      run: |
        func start --verbose &
        sleep 10

    - name: Test function with sample input
      run: |
        curl -X POST http://localhost:7071/api/latestocr \
          -H "Content-Type: application/json" \
          -d @latestocr/sample.dat \
          --max-time 30

    - name: Verify function is running
      run: |
        if curl -f http://localhost:7071/api/latestocr > /dev/null 2>&1; then
          echo "Function is responding"
        else
          echo "Function is not responding"
          exit 1
        fi