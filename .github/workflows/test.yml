name: Basic Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  USE_REAL_AZURE: ${{ secrets.USE_REAL_AZURE || 'false' }}
  FR_ENDPOINT: ${{ secrets.FR_ENDPOINT }}
  FR_ENDPOINT_KEY: ${{ secrets.FR_ENDPOINT_KEY }}
  TEST_DOCUMENT_URL: ${{ secrets.TEST_DOCUMENT_URL }}
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check syntax
      run: |
        python -m py_compile latestocr/__init__.py

    - name: Test imports
      run: |
        python -c "import latestocr.__init__; print('Imports successful')"

    - name: Run init file
      run: |
        python latestocr/__init__.py

    - name: Test Azure Function main()
      run: |
        python - <<'EOF'
        import os, json, base64
        import azure.functions as func
        import latestocr.__init__ as app

        # Set environment variables
        os.environ["FR_ENDPOINT"] = os.getenv("FR_ENDPOINT", "https://example.cognitiveservices.azure.com/")
        os.environ["FR_ENDPOINT_KEY"] = os.getenv("FR_ENDPOINT_KEY", "fake-key")

        # Original SAS URL
        sas_url = "https://hadil.blob.core.windows.net/hadil/Hadil-BEN-AMOR-resume_updated.pdf?sp=r&st=2025-11-04T00:29:59Z&se=2025-11-04T08:44:59Z&spr=https&sv=2024-11-04&sr=b&sig=bdDrXrMBxJggHaKNcWm064s0ySjWszEuSh3%2FMFk6c%3D"

        # Split into file URL and SAS token
        url, token = sas_url.split("?", 1)

        # Base64 encode URL with proper padding
        encoded_url = base64.b64encode(url.encode("utf-8")).decode("utf-8")
        padding_needed = 4 - (len(encoded_url) % 4)
        if padding_needed != 4:
            encoded_url += "=" * padding_needed

        # Build test request payload
        test_data = {
            "values": [
                {
                    "recordId": "1",
                    "data": {
                        "Url": encoded_url,
                        "SasToken": "?" + token
                    }
                }
            ]
        }

        req = func.HttpRequest(
            method="POST",
            url="/api/ocr",
            body=json.dumps(test_data).encode('utf-8')
        )

        # Call the main function
        resp = app.main(req)
        print("Status:", resp.status_code)
        print("Test Data:", test_data)
        print("Body:", resp.get_body().decode())
        EOF

        