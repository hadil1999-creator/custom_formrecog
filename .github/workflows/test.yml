name: Basic Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  USE_REAL_AZURE: ${{ secrets.USE_REAL_AZURE || 'false' }}
  FR_ENDPOINT: ${{ secrets.FR_ENDPOINT }}
  FR_ENDPOINT_KEY: ${{ secrets.FR_ENDPOINT_KEY }}
  TEST_DOCUMENT_URL: ${{ secrets.TEST_DOCUMENT_URL }}
jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check syntax
      run: |
        python -m py_compile latestocr/__init__.py

    - name: Test imports
      run: |
        python -c "import latestocr.__init__; print('Imports successful')"


    - name: Test Azure Function main()
      run: |
        python - <<'EOF'
        import os, json, base64
        import azure.functions as func
        import latestocr.__init__ as app

        # Set environment variables
        os.environ["FR_ENDPOINT"] = os.getenv("FR_ENDPOINT", "https://example.cognitiveservices.azure.com/")
        os.environ["FR_ENDPOINT_KEY"] = os.getenv("FR_ENDPOINT_KEY", "fake-key")

        # SAS URL of your blob file
        sas_url = "https://hadil.blob.core.windows.net/hadil/Hadil-BEN-AMOR-resume_updated.pdf?sp=r&st=2025-11-04T01:23:11Z&se=2026-02-05T09:38:11Z&sv=2024-11-04&sr=b&sig=Ul2DY94iNBZ1tcLn1j384%2BNT8JRYQnwawvqJltP9dXc%3D"

        # Make sure no spaces or newlines are around
        sas_url = sas_url.replace(" ", "").replace("\n", "")

        # Split into file URL and SAS token
        if "?" in sas_url:
            url, token = sas_url.split("?", 1)
        else:
            raise ValueError("SAS URL missing '?' separator")

        print("Base URL:", repr(url))
        print("SAS Token:", repr(token))
        # Force correct base64 padding (multiple of 4)
        encoded_url = base64.b64encode(url.encode("utf-8")).decode("utf-8")
        while len(encoded_url) % 4 != 0:
            encoded_url += "="

        # Build test data payload
        test_data = {
            "values": [
                {
                    "recordId": "1",
                    "data": {
                        "Url": encoded_url,
                        "SasToken": "?" + token
                    }
                }
            ]
        }
        print(test_data)
        # Create HTTP request
        req = func.HttpRequest(
            method="POST",
            url="/api/ocr",
            body=json.dumps(test_data).encode("utf-8")
        )

        # Run the Azure Function locally
        resp = app.main(req)
        print("Status:", resp.status_code)
        print("Body:", resp.get_body().decode())
        EOF


